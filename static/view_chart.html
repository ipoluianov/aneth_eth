<div id="app">
    <h1>%VIEW_NAME%</h1>
    <div style="padding-bottom: 10px;">%VIEW_DESC%</div>
    <!--div style="border: 1px solid #FFFFFF20;">
        <canvas id="myChart_VIEW_INSTANCE" style="width:100%;height: 250px;min-height: 250px;"></canvas>
    </div-->
    <div id="chartContainer"></div>
    <div style="padding-top: 10px;">%VIEW_TEXT%</div>
</div>

<script>
    let chartInstance_VIEW_INSTANCE;
    let items_VIEW_INSTANCE = [];

    function toUnixTime(dateString) {
            const [datePart, timePart] = dateString.split(' ');
            const [year, month, day] = datePart.split('-').map(Number);
            const [hours, minutes, seconds] = timePart.split(':').map(Number);
            //const date = new Date(year, month - 1, day, hours, minutes, seconds);
            const date = this.getUnixTimeInUTCFromParams(year, month, day, hours, minutes, seconds);
            return Math.floor(date);
        }


    function loadData1() {
        console.log("load data")
        loadJson("/d/%VIEW_CODE%").then(data => {
            items_VIEW_INSTANCE = data.TimeChart.Items;
            let xValues = [];
            let yValues = [];

            for (let i in items_VIEW_INSTANCE) {
                let item = items_VIEW_INSTANCE[i];
                xValues.push(item["DTStr"]);
                yValues.push(item["Value"]);
            }

            if (chartInstance_VIEW_INSTANCE) {
                let xData = [];
                let yData = [];
                for (let i in xValues) {
                    let dt = toUnixTime(xValues[i]);
                    const now = new Date();
                    const timezoneOffsetInSeconds = now.getTimezoneOffset() * 60;
                    const unixTimeWithTimezone = Math.floor((dt * 1000 - timezoneOffsetInSeconds * 1000) / 1000);
                    xData.push(unixTimeWithTimezone);
                }
                chartInstance_VIEW_INSTANCE.setData(xData, yValues);
            }
        })
            .catch(error => {
                console.log(error)
            });
    }


    console.log("mounted")



    function getUnixTimeInUTCFromParams(year, month, day, hours, minutes, seconds) {
        const utcTime = Date.UTC(year, month - 1, day, hours, minutes, seconds);
        return Math.floor(utcTime / 1000);
    }

    function toUnixTime(dateString) {
        const [datePart, timePart] = dateString.split(' ');
        const [year, month, day] = datePart.split('-').map(Number);
        const [hours, minutes, seconds] = timePart.split(':').map(Number);
        //const date = new Date(year, month - 1, day, hours, minutes, seconds);
        const date = this.getUnixTimeInUTCFromParams(year, month, day, hours, minutes, seconds);
        return Math.floor(date);
    }

    const now = new Date();
    const unixTimeNow = Math.floor(now.getTime() / 1000);
    const timezoneOffsetInSeconds = now.getTimezoneOffset() * 60;
    const unixTimeWithTimezone = Math.floor((now.getTime() - timezoneOffsetInSeconds * 1000) / 1000);


    chartInstance_VIEW_INSTANCE = new MetricsChart(
        '%VIEW_NAME%',
        'chartContainer',
        [],
        [],
        400,
        unixTimeWithTimezone - 86400,
        unixTimeWithTimezone,
    );


    loadData1();
    setInterval(loadData1, 3000);
</script>